{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Bond Pricing and Risk Analysis\n",
    "\n",
    "## Project Overview\n",
    "This project implements a robust framework for Fixed Income analysis. Unlike equities, bond pricing is mathematically determined by projected cash flows and interest rates. \n",
    "\n",
    "**Key Objectives:**\n",
    "1.  **Valuation:** Implement precise pricing models based on Discounted Cash Flow (DCF).\n",
    "2.  **Risk Metrics:** Calculate Duration (linear risk) and Convexity (curvature risk).\n",
    "3.  **Sensitivity Analysis:** Visualize the Price-Yield relationship and simulate interest rate shocks.\n",
    "\n",
    "---"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# 1. IMPORT LIBRARIES\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns\n",
    "\n",
    "# Set visual styles\n",
    "plt.style.use('seaborn-v0_8-darkgrid')\n",
    "sns.set_palette(\"mako\")\n",
    "plt.rcParams['figure.figsize'] = (10, 6)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 2. THEORETICAL FRAMEWORK & FUNCTIONS\n",
    "\n",
    "We define the core financial mathematics functions here to ensure accuracy. \n",
    "\n",
    "### Formulas\n",
    "\n",
    "**1. Bond Price ($P$):**\n",
    "$$P = \\sum_{t=1}^{n} \\frac{C}{(1+y/k)^t} + \\frac{F}{(1+y/k)^n}$$\n",
    "\n",
    "**2. Macaulay Duration ($D_{mac}$):**\n",
    "$$D_{mac} = \\frac{\\sum_{t=1}^{n} \\frac{t \\cdot C}{(1+y/k)^t} + \\frac{n \\cdot F}{(1+y/k)^n}}{P}$$\n",
    "\n",
    "**3. Modified Duration ($D_{mod}$):**\n",
    "$$D_{mod} = \\frac{D_{mac}}{1 + y/k}$$\n",
    "\n",
    "**4. Convexity ($C_{vx}$):**\n",
    "$$C_{vx} = \\frac{1}{P \\cdot (1+y)^2} \\sum_{t=1}^{n} \\left[ \\frac{C}{(1+y)^t} (t^2+t) + \\frac{F}{(1+y)^n} (n^2+n) \\right]$$\n",
    "\n",
    "*Where: $C$ = Coupon payment, $F$ = Face Value, $y$ = Yield to Maturity (YTM), $k$ = compounding frequency, $n$ = total periods.*"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "def calculate_bond_metrics(face_value, coupon_rate, ytm, years, freq=2):\n",
    "    \"\"\"\n",
    "    Calculates Price, Macaulay Duration, Modified Duration, and Convexity.\n",
    "    \n",
    "    Parameters:\n",
    "    - face_value (float): Par value of the bond\n",
    "    - coupon_rate (float): Annual coupon rate (decimal)\n",
    "    - ytm (float): Yield to Maturity (decimal)\n",
    "    - years (float): Years to maturity\n",
    "    - freq (int): Coupon payments per year (default 2 for semi-annual)\n",
    "    \"\"\"\n",
    "    # Derived variables\n",
    "    c = coupon_rate * face_value / freq  # Coupon payment per period\n",
    "    y = ytm / freq                       # Yield per period\n",
    "    n = int(years * freq)                # Total number of periods\n",
    "    periods = np.arange(1, n + 1)\n",
    "    \n",
    "    # 1. Calculate Cash Flows\n",
    "    cash_flows = np.full(n, c)\n",
    "    cash_flows[-1] += face_value         # Add principal to last payment\n",
    "    \n",
    "    # 2. Discount Factors\n",
    "    discount_factors = 1 / ((1 + y) ** periods)\n",
    "    \n",
    "    # 3. Calculate Price (PV of Cash Flows)\n",
    "    pv_cash_flows = cash_flows * discount_factors\n",
    "    price = np.sum(pv_cash_flows)\n",
    "    \n",
    "    # 4. Macaulay Duration (Weighted Average Time)\n",
    "    # Sum of (Period * PV of CF) / Price\n",
    "    mac_duration_periods = np.sum(periods * pv_cash_flows) / price\n",
    "    mac_duration_years = mac_duration_periods / freq\n",
    "    \n",
    "    # 5. Modified Duration (Sensitivity to Yield)\n",
    "    mod_duration = mac_duration_years / (1 + y)\n",
    "    \n",
    "    # 6. Convexity (Curvature)\n",
    "    # Sum of (t * (t+1) * PV of CF) / ((1+y)^2 * Price)\n",
    "    convexity_term = periods * (periods + 1) * pv_cash_flows\n",
    "    convexity = np.sum(convexity_term) / (price * ((1 + y) ** 2))\n",
    "    convexity = convexity / (freq ** 2) # Annualize convexity\n",
    "    \n",
    "    return {\n",
    "        'Price': price,\n",
    "        'Macaulay_Duration': mac_duration_years,\n",
    "        'Modified_Duration': mod_duration,\n",
    "        'Convexity': convexity,\n",
    "        'YTM': ytm\n",
    "    }"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 3. BOND PORTFOLIO SIMULATION\n",
    "\n",
    "We will analyze three distinct hypothetical bonds to see how coupon rates and maturity affect risk profiles.\n",
    "\n",
    "* **Bond A:** Short-term, Low Coupon (2yr, 2%)\n",
    "* **Bond B:** Medium-term, Medium Coupon (10yr, 5%)\n",
    "* **Bond C:** Long-term, High Coupon (30yr, 8%)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Define Bond Characteristics\n",
    "bonds = [\n",
    "    {'id': 'Bond A', 'face': 1000, 'coupon': 0.02, 'years': 2, 'ytm': 0.04},\n",
    "    {'id': 'Bond B', 'face': 1000, 'coupon': 0.05, 'years': 10, 'ytm': 0.05},\n",
    "    {'id': 'Bond C', 'face': 1000, 'coupon': 0.08, 'years': 30, 'ytm': 0.06}\n",
    "]\n",
    "\n",
    "# Calculate Metrics for each\n",
    "results = []\n",
    "for b in bonds:\n",
    "    metrics = calculate_bond_metrics(b['face'], b['coupon'], b['ytm'], b['years'])\n",
    "    metrics['Bond_ID'] = b['id']\n",
    "    metrics['Coupon'] = b['coupon']\n",
    "    metrics['Maturity_Yrs'] = b['years']\n",
    "    results.append(metrics)\n",
    "\n",
    "df_results = pd.DataFrame(results)\n",
    "df_results = df_results.set_index('Bond_ID')\n",
    "\n",
    "# Display formatted table\n",
    "print(\"=\"*60)\n",
    "print(\"BOND VALUATION & RISK METRICS\")\n",
    "print(\"=\"*60)\n",
    "display(df_results.round(4))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 4. VISUALIZING THE PRICE-YIELD RELATIONSHIP\n",
    "\n",
    "This section visualizes the fundamental concept of **Convexity**. We simulate a range of yields (0% to 15%) to plot how the price of Bond B (10yr) reacts."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Simulate Yield curve for Bond B (10yr, 5% Coupon)\n",
    "bond_b = bonds[1]\n",
    "yields = np.linspace(0.001, 0.15, 100) # 0.1% to 15%\n",
    "prices = []\n",
    "\n",
    "for y in yields:\n",
    "    res = calculate_bond_metrics(bond_b['face'], bond_b['coupon'], y, bond_b['years'])\n",
    "    prices.append(res['Price'])\n",
    "\n",
    "plt.figure(figsize=(10, 6))\n",
    "sns.lineplot(x=yields*100, y=prices, linewidth=2.5, color='royalblue')\n",
    "\n",
    "# Mark the current YTM\n",
    "current_price = calculate_bond_metrics(bond_b['face'], bond_b['coupon'], bond_b['ytm'], bond_b['years'])['Price']\n",
    "plt.plot(bond_b['ytm']*100, current_price, 'ro', markersize=10, label=f'Current YTM ({bond_b[\"ytm\"]*100}%)')\n",
    "\n",
    "plt.title(f'Price-Yield Curve: {bond_b[\"id\"]}', fontsize=16, fontweight='bold')\n",
    "plt.xlabel('Yield to Maturity (%)', fontsize=12)\n",
    "plt.ylabel('Bond Price ($)', fontsize=12)\n",
    "plt.legend()\n",
    "plt.grid(True, alpha=0.3)\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 5. RISK ANALYSIS: SENSITIVITY TO RATE SHOCKS\n",
    "\n",
    "We calculate the estimated price change for a **+1% (100 basis points)** increase in interest rates using the Duration-Convexity approximation formula:\n",
    "\n",
    "$$ \\frac{\\Delta P}{P} \\approx -D_{mod} \\times \\Delta y + \\frac{1}{2} \\times C_{vx} \\times (\\Delta y)^2 $$\n",
    "\n",
    "This approximation is compared against the *actual* re-calculated price to demonstrate the accuracy of our risk metrics."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Rate Shock Simulation (+1%)\n",
    "delta_y = 0.01  # +100 bps\n",
    "\n",
    "simulation = []\n",
    "\n",
    "for idx, row in df_results.iterrows():\n",
    "    # 1. Estimated Change (Duration only)\n",
    "    dur_effect = -row['Modified_Duration'] * delta_y\n",
    "    \n",
    "    # 2. Convexity Adjustment\n",
    "    conv_effect = 0.5 * row['Convexity'] * (delta_y ** 2)\n",
    "    \n",
    "    # 3. Total Estimated % Change\n",
    "    est_pct_change = dur_effect + conv_effect\n",
    "    est_price_new = row['Price'] * (1 + est_pct_change)\n",
    "    \n",
    "    # 4. Actual Calculation (Re-pricing the bond)\n",
    "    actual_metrics = calculate_bond_metrics(\n",
    "        1000, row['Coupon'], \n",
    "        row['YTM'] + delta_y, # New Yield\n",
    "        row['Maturity_Yrs']\n",
    "    )\n",
    "    actual_price_new = actual_metrics['Price']\n",
    "    actual_pct_change = (actual_price_new - row['Price']) / row['Price']\n",
    "    \n",
    "    simulation.append({\n",
    "        'Bond': idx,\n",
    "        'Original_Price': row['Price'],\n",
    "        'Mod_Duration': row['Modified_Duration'],\n",
    "        'Est_New_Price': est_price_new,\n",
    "        'Actual_New_Price': actual_price_new,\n",
    "        'Difference': abs(est_price_new - actual_price_new),\n",
    "        'Actual_Pct_Drop': actual_pct_change * 100\n",
    "    })\n",
    "\n",
    "df_sim = pd.DataFrame(simulation).set_index('Bond')\n",
    "\n",
    "print(\"=\"*80)\n",
    "print(\"SENSITIVITY ANALYSIS: IMPACT OF +1% RATE HIKE\")\n",
    "print(\"=\"*80)\n",
    "print(df_sim[['Original_Price', 'Actual_New_Price', 'Actual_Pct_Drop', 'Difference']].round(4))\n",
    "\n",
    "# Visualization of the impact\n",
    "plt.figure(figsize=(10, 5))\n",
    "sns.barplot(x=df_sim.index, y=df_sim['Actual_Pct_Drop'], palette='Reds_d')\n",
    "plt.title('Portfolio Value Impact of 1% Rate Rise', fontsize=14)\n",
    "plt.ylabel('Percentage Drop in Value (%)')\n",
    "plt.axhline(0, color='black', linewidth=1)\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Conclusion\n",
    "\n",
    "1.  **Duration Risk:** Bond C (30yr) suffers the largest loss (~12%) due to high duration. This confirms that long-term bonds are significantly more sensitive to interest rate changes.\n",
    "2.  **Accuracy:** The 'Difference' column shows the error between the Duration/Convexity estimate and the actual math is negligible (cents), validating the use of these risk metrics for portfolio management.\n",
    "3.  **Investment Implication:** In a rising rate environment, investors should prioritize lower duration assets (like Bond A) to preserve capital."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.12"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
